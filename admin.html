<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAHI | Ultimate Admin</title>
    <style>
        :root { --bg: #0b0e14; --card: #161b22; --primary: #38bdf8; --green: #22c55e; --red: #ef4444; }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; padding: 20px; display: none; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: var(--card); border: 1px solid #333; padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        .section-title { color: var(--primary); border-left: 4px solid var(--primary); padding-left: 10px; margin: 20px 0; }
        button { padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-green { background: var(--green); color: #000; }
        .btn-red { background: var(--red); color: #fff; }
        input { width: 100%; padding: 10px; background: #000; border: 1px solid #333; color: #fff; border-radius: 8px; margin-top: 10px; box-sizing: border-box;}
        .req-card { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding: 10px 0; }
    </style>
</head>
<body>

    <h2 id="admin-head">üõ†Ô∏è SAHI Command Center</h2>

    <div class="section-title">üìà Live Market Controller (Graph Data)</div>
    <div class="card">
        <div style="font-size: 24px; font-weight: 800; text-align: center;">Current: ‚Çπ<span id="live-p">0.00</span></div>
        <div class="grid" style="margin-top:15px;">
            <button class="btn-green" onclick="setTrend('up')">Push Price UP ‚Üë</button>
            <button class="btn-red" onclick="setTrend('down')">Push Price DOWN ‚Üì</button>
        </div>
        <p style="font-size: 11px; opacity: 0.5; text-align: center; margin-top: 10px;">Yeh panel khula rehne par graph update hota rahega.</p>
    </div>

    <div class="section-title">üì• Wallet Requests (Deposit/Withdraw)</div>
    <div class="card" id="req-list">Loading requests...</div>

    <div class="section-title">üë• User Management & History</div>
    <div id="user-list"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, where, orderBy, limit, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCuCNl6FOWldVkjGAlqU1eTxPPOWn_pKtY",
            authDomain: "lightspeed-trading-1dec9.firebaseapp.com",
            projectId: "lightspeed-trading-1dec9",
            storageBucket: "lightspeed-trading-1dec9.firebasestorage.app",
            messagingSenderId: "787355268629",
            appId: "1:787355268629:web:c5c39b7706c6a3548e001c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Security Prompt
        const pass = prompt("Enter Admin Key:");
        if(pass === "786") { document.body.style.display = "block"; } 
        else { window.location.href = "index.html"; }

        // --- MARKET ENGINE (Updating Graph History) ---
        let currentPrice = 165.00;
        let trend = "normal";

        window.setTrend = (t) => { trend = t; alert("Trend set to: " + t); };

        setInterval(async () => {
            if(trend === "up") currentPrice += Math.random() * 2;
            else if(trend === "down") currentPrice -= Math.random() * 2;
            else currentPrice += (Math.random() - 0.5) * 1.5;

            document.getElementById('live-p').innerText = currentPrice.toFixed(2);

            // Save to history so user graph stays persistent
            await addDoc(collection(db, "market_history"), {
                price: currentPrice,
                time: serverTimestamp()
            });

            // Cleanup: Sirf latest 50 points rakhein (Database clean rakhne ke liye)
        }, 4000);

        // --- WALLET REQUESTS LOGIC ---
        onSnapshot(query(collection(db, "requests"), where("status", "==", "pending")), (snap) => {
            const cont = document.getElementById('req-list');
            cont.innerHTML = snap.empty ? "No pending requests" : "";
            snap.forEach(d => {
                const r = d.data();
                cont.innerHTML += `
                    <div class="req-card">
                        <div><b>${r.email}</b><br><small>${r.type}: ‚Çπ${r.amount}</small></div>
                        <button class="btn-green" onclick="approveReq('${d.id}', '${r.uid}', ${r.amount}, '${r.type}')">Approve</button>
                    </div>`;
            });
        });

        window.approveReq = async (id, uid, amt, type) => {
            const uRef = doc(db, "users", uid);
            const uSnap = await getDoc(uRef);
            let newBal = type === 'Deposit' ? (uSnap.data().wallet + amt) : (uSnap.data().wallet - amt);
            
            await updateDoc(uRef, { wallet: newBal });
            await updateDoc(doc(db, "requests", id), { status: "approved" });
            alert("Success!");
        };

        // --- USER LIST ---
        onSnapshot(collection(db, "users"), (snap) => {
            const cont = document.getElementById('user-list');
            cont.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                cont.innerHTML += `
                    <div class="card">
                        <b>${u.name || 'Trader'}</b> | Bal: ‚Çπ${u.wallet.toFixed(2)}
                        <input type="number" id="bal-${d.id}" placeholder="New Balance">
                        <button class="btn-green" style="margin-top:5px; width:100%" onclick="manualBal('${d.id}')">Update Balance</button>
                    </div>`;
            });
        });

        window.manualBal = async (id) => {
            const val = parseFloat(document.getElementById('bal-'+id).value);
            if(!isNaN(val)) {
                await updateDoc(doc(db, "users", id), { wallet: val });
                alert("Updated!");
            }
        };

    </script>
</body>
</html>
