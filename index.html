<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAHI | High Performance Trading</title>
    <style>
        :root { --primary: linear-gradient(90deg, #6366f1, #a855f7); --bg: #0b0e14; --card: #161b22; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; }
        .container { max-width: 420px; margin: auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }

        /* Login Screen (As per Screenshot) */
        .brand { text-align: center; margin: 40px 0; }
        .brand h1 { font-size: 36px; letter-spacing: 4px; font-weight: 900; }
        .hero-text { text-align: center; font-size: 28px; font-weight: bold; margin-bottom: 40px; }
        .google-btn { background: #fff; color: #000; width: 100%; padding: 15px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* Dashboard */
        .wallet-card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #30363d; cursor: pointer; margin-bottom: 20px; }
        .price-val { font-size: 42px; font-weight: 800; text-align: center; margin: 20px 0; }
        .up { color: #22c55e; } .down { color: #ef4444; }
        canvas { width: 100%; height: 180px; background: rgba(0,0,0,0.2); border-radius: 10px; }

        /* Modal / Popup */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 20px; width: 85%; border: 1px solid #30363d; }
        input { width: 100%; padding: 12px; margin: 15px 0; border-radius: 10px; border: 1px solid #30363d; background: #000; color: #fff; text-align: center; box-sizing: border-box; }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .buy-btn { background: #22c55e; color: #000; font-weight: bold; border: none; padding: 15px; border-radius: 12px; cursor: pointer; }
        .sell-btn { background: #ef4444; color: #fff; font-weight: bold; border: none; padding: 15px; border-radius: 12px; cursor: pointer; }
        
        #wallet-ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 500; padding: 20px; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="auth-screen" class="container">
    <div class="brand"><h1>SAHI</h1><p>F&O | Stocks | ETF | IPO</p></div>
    <div class="hero-text">High Performance<br>Trading</div>
    <button class="google-btn" onclick="login()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18">
        Continue with Google
    </button>
</div>

<div id="app-screen" class="container hidden">
    <div class="wallet-card" onclick="toggleWallet(true)">
        <div style="font-size: 12px; opacity: 0.6;">Available Margin (Manage)</div>
        <div style="font-size: 24px; font-weight: bold;">₹<span id="bal-display">0.00</span></div>
    </div>

    <div class="price-val" id="price-display">₹166.65</div>
    <canvas id="chartCanvas"></canvas>

    <div class="btn-grid">
        <button class="buy-btn" onclick="openTrade('buy')">BUY</button>
        <button class="sell-btn" onclick="openTrade('sell')">SELL</button>
    </div>
</div>

<div id="wallet-ui" class="hidden">
    <button onclick="toggleWallet(false)" style="background:none; border:1px solid #333; color:#fff; padding:10px; border-radius:8px;">← Back</button>
    <h2 style="margin-top:30px;">Wallet</h2>
    <div class="wallet-card">
        <p>Current Balance: ₹<span id="bal-display-2">0.00</span></p>
    </div>
    <div class="btn-grid">
        <button class="buy-btn" style="background:#38bdf8" onclick="reqMoney('Deposit')">ADD MONEY</button>
        <button class="sell-btn" style="background:#fff; color:#000" onclick="reqMoney('Withdraw')">WITHDRAW</button>
    </div>
</div>

<div id="trade-modal" class="modal hidden">
    <div class="modal-content">
        <h3 id="m-title">BUY LSC</h3>
        <p style="font-size:12px; opacity:0.6;">Current Price: ₹<span id="m-price">0</span></p>
        <input type="number" id="t-qty" value="1" min="1">
        <div class="btn-grid">
            <button id="m-confirm" class="buy-btn" onclick="confirmTrade()">Confirm</button>
            <button onclick="closeTrade()" style="background:#333; color:#fff; border:none; border-radius:12px;">Cancel</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCuCNl6FOWldVkjGAlqU1eTxPPOWn_pKtY",
        authDomain: "lightspeed-trading-1dec9.firebaseapp.com",
        projectId: "lightspeed-trading-1dec9",
        storageBucket: "lightspeed-trading-1dec9.firebasestorage.app",
        messagingSenderId: "787355268629",
        appId: "1:787355268629:web:c5c39b7706c6a3548e001c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let price = 166.65;
    let userData = {};
    let currentMode = 'buy';
    let history = JSON.parse(localStorage.getItem('trade_history')) || [];

    window.login = () => signInWithPopup(auth, provider);
    window.toggleWallet = (show) => document.getElementById('wallet-ui').className = show ? '' : 'hidden';

    window.openTrade = (mode) => {
        currentMode = mode;
        document.getElementById('trade-modal').classList.remove('hidden');
        document.getElementById('m-title').innerText = mode.toUpperCase() + " LIGHTSPEED";
        document.getElementById('m-price').innerText = price.toFixed(2);
        document.getElementById('m-confirm').className = mode + "-btn";
    };

    window.closeTrade = () => document.getElementById('trade-modal').classList.add('hidden');

    window.confirmTrade = async () => {
        const qty = parseInt(document.getElementById('t-qty').value);
        const total = price * qty;
        const uRef = doc(db, "users", auth.currentUser.uid);

        if(currentMode === 'buy' && userData.wallet >= total) {
            let newAvg = ((userData.holdings * userData.avgPrice) + total) / (userData.holdings + qty);
            await updateDoc(uRef, { wallet: userData.wallet - total, holdings: userData.holdings + qty, avgPrice: newAvg });
        } else if(currentMode === 'sell' && userData.holdings >= qty) {
            await updateDoc(uRef, { wallet: userData.wallet + total, holdings: userData.holdings - qty });
        } else {
            alert("Insufficient Funds/Holdings!");
        }
        closeTrade();
    };

    window.reqMoney = async (type) => {
        const amt = prompt(`Enter ${type} Amount:`);
        if(amt && !isNaN(amt)) {
            await addDoc(collection(db, "requests"), {
                uid: auth.currentUser.uid,
                email: auth.currentUser.email,
                amount: parseFloat(amt),
                type: type,
                status: "pending",
                time: serverTimestamp()
            });
            alert("Request sent!");
        }
    };

    onAuthStateChanged(auth, async (user) => {
        if(user) {
            const uRef = doc(db, "users", user.uid);
            const snap = await getDoc(uRef);
            if(!snap.exists()) await setDoc(uRef, { wallet: 10000, holdings: 0, avgPrice: 0 });
            
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');

            onSnapshot(uRef, (d) => {
                userData = d.data();
                document.getElementById('bal-display').innerText = userData.wallet.toFixed(2);
                document.getElementById('bal-display-2').innerText = userData.wallet.toFixed(2);
            });
            startMarket();
        }
    });

    function startMarket() {
        setInterval(() => {
            price += (Math.random() - 0.5) * 1.5;
            document.getElementById('price-display').innerText = "₹" + price.toFixed(2);
            const now = Date.now();
            history.push({ p: price, t: now });
            // 3 Day Filter (259200000 ms)
            history = history.filter(h => now - h.t < 259200000);
            localStorage.setItem('trade_history', JSON.stringify(history));
            drawChart();
        }, 3000);
    }

    function drawChart() {
        const c = document.getElementById('chartCanvas');
        const ctx = c.getContext('2d');
        ctx.clearRect(0,0,c.width,c.height);
        ctx.beginPath(); ctx.strokeStyle = "#38bdf8"; ctx.lineWidth = 2;
        let pArr = history.map(h => h.p);
        let min = Math.min(...pArr), max = Math.max(...pArr), r = max - min + 1;
        pArr.slice(-40).forEach((p, i) => {
            let x = (i/39) * c.width;
            let y = c.height - ((p-min)/r) * c.height;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
    }
</script>
</body>
</html>
