<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SAHI | Demo Trading</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
 --bg:#0b0e14;--card:#161b22;
 --green:#22c55e;--red:#ef4444;--blue:#38bdf8;
}
body{margin:0;background:var(--bg);color:#fff;font-family:Segoe UI,sans-serif}
.container{max-width:420px;margin:auto;padding:20px;min-height:100vh}
.hidden{display:none!important}
.card{background:var(--card);border:1px solid #30363d;border-radius:16px;padding:16px;margin-bottom:15px}
.price{font-size:42px;font-weight:900;text-align:center}
.up{color:var(--green)}.down{color:var(--red)}
canvas{width:100%;background:#000;border-radius:12px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
button{padding:14px;border:none;border-radius:14px;font-weight:800;cursor:pointer}
.buy{background:var(--green);color:#000}
.sell{background:var(--red);color:#fff}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:999}
.modal-box{background:var(--card);padding:25px;border-radius:20px;width:85%}
input{width:100%;padding:14px;border-radius:12px;border:1px solid #333;background:#000;color:#fff;text-align:center;margin:15px 0}
.tab-btns{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px}
</style>
</head>

<body>

<!-- AUTH -->
<div id="auth" class="container">
 <h1 style="text-align:center">SAHI</h1>
 <p style="text-align:center;opacity:.6">High Performance Trading</p>
 <button onclick="login()" style="width:100%">Continue with Google</button>
</div>

<!-- APP -->
<div id="app" class="container hidden">

<div class="tab-btns">
 <button onclick="switchTab('market')">Market</button>
 <button onclick="switchTab('history')">History</button>
 <button onclick="switchTab('leader')">Leaderboard</button>
</div>

<div id="tab-market">
 <div class="card">
  Balance ₹<b><span id="bal">0</span></b>
 </div>

 <div id="price" class="price">₹0.00</div>

 <canvas id="lineChart" width="360" height="120"></canvas>
 <canvas id="candleChart" width="360" height="200"></canvas>

 <div class="card">
  Qty: <b><span id="qty">0</span></b><br>
  Avg: ₹<b><span id="avg">0</span></b><br>
  P/L: ₹<b><span id="pl">0</span></b>
 </div>

 <div class="grid">
  <button class="buy" onclick="openTrade('buy')">BUY</button>
  <button class="sell" onclick="openTrade('sell')">SELL</button>
 </div>
</div>

<div id="tab-history" class="hidden"></div>
<div id="tab-leader" class="hidden"></div>

</div>

<!-- MODAL -->
<div id="trade" class="modal hidden">
 <div class="modal-box">
  <h3 id="t-title"></h3>
  Price ₹<span id="t-price"></span>
  <input type="number" id="t-qty" value="1" min="1">
  <div class="grid">
   <button id="t-confirm"></button>
   <button onclick="closeTrade()">Cancel</button>
  </div>
 </div>
</div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import{getAuth,GoogleAuthProvider,signInWithPopup,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import{getFirestore,doc,getDoc,setDoc,updateDoc,onSnapshot,collection,addDoc,query,where,orderBy,getDocs,serverTimestamp}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app=initializeApp({
 apiKey:"AIzaSyCuCNl6FOWldVkjGAlqU1eTxPPOWn_pKtY",
 authDomain:"lightspeed-trading-1dec9.firebaseapp.com",
 projectId:"lightspeed-trading-1dec9"
});
const auth=getAuth(app),db=getFirestore(app),provider=new GoogleAuthProvider();

let price=166,lastPrice=price,trend=(Math.random()-.5)*.3;
let line=[],candles=[],cur=null,cStart=0,started=false;
let user={},mode="buy";

window.login=()=>signInWithPopup(auth,provider);

window.switchTab=t=>{
 ["market","history","leader"].forEach(x=>document.getElementById("tab-"+x).classList.add("hidden"));
 document.getElementById("tab-"+t).classList.remove("hidden");
 if(t==="leader")loadLeaderboard();
};

window.openTrade=m=>{
 mode=m;trade.classList.remove("hidden");
 t-title.innerText=m.toUpperCase();
 t-price.innerText=price.toFixed(2);
 t-confirm.innerText=m.toUpperCase();
 t-confirm.className=m;
};

window.closeTrade=()=>trade.classList.add("hidden");

t-confirm.onclick=async()=>{
 let q=+t-qty.value,total=q*price,ref=doc(db,"users",auth.currentUser.uid);
 if(mode=="buy"&&user.wallet>=total){
  let avg=((user.avg*user.qty)+(price*q))/(user.qty+q);
  await updateDoc(ref,{wallet:user.wallet-total,qty:user.qty+q,avg});
 }
 if(mode=="sell"&&user.qty>=q){
  await updateDoc(ref,{wallet:user.wallet+total,qty:user.qty-q});
 }
 await addDoc(collection(db,"trades"),{uid:auth.currentUser.uid,type:mode,qty:q,price,total,time:serverTimestamp()});
 closeTrade();
};

onAuthStateChanged(auth,async u=>{
 if(!u)return;
 let ref=doc(db,"users",u.uid);
 let s=await getDoc(ref);
 if(!s.exists())await setDoc(ref,{wallet:10000,qty:0,avg:0});
 auth.classList.add("hidden");app.classList.remove("hidden");

 onSnapshot(ref,d=>{
  user=d.data();
  bal.innerText=user.wallet.toFixed(2);
  qty.innerText=user.qty;
  avg.innerText=user.avg.toFixed(2);
  let p=(price-user.avg)*user.qty;
  pl.innerText=p.toFixed(2);
  pl.style.color=p>=0?"#22c55e":"#ef4444";
 });
 loadHistory(); startMarket();
});

function startMarket(){
 if(started)return;started=true;
 setInterval(()=>{
  if(Math.random()<.05)trend=(Math.random()-.5)*.6;
  price+=trend+(Math.random()-.5);
  price=Math.max(50,Math.min(300,price));
  render();
 },3000);
}

function render(){
 priceEl.innerText="₹"+price.toFixed(2);
 priceEl.className="price "+(price>=lastPrice?"up":"down");
 lastPrice=price;

 line.push(price);line=line.slice(-40);
 updateCandle(price);
 drawLine();drawCandle();
}

function updateCandle(p){
 let now=Date.now();
 if(!cur){cur={o:p,h:p,l:p,c:p};cStart=now}
 cur.h=Math.max(cur.h,p);cur.l=Math.min(cur.l,p);cur.c=p;
 if(now-cStart>60000){candles.push(cur);candles=candles.slice(-30);cur=null}
}

function drawLine(){
 let c=lineChart,ctx=c.getContext("2d");
 ctx.clearRect(0,0,c.width,c.height);
 let min=Math.min(...line),max=Math.max(...line),r=max-min||1;
 ctx.beginPath();ctx.strokeStyle="#38bdf8";ctx.lineWidth=2;
 line.forEach((p,i)=>{
  let x=i/(line.length-1)*c.width;
  let y=c.height-((p-min)/r)*c.height;
  i?ctx.lineTo(x,y):ctx.moveTo(x,y);
 });ctx.stroke();
}

function drawCandle(){
 let c=candleChart,ctx=c.getContext("2d");
 ctx.clearRect(0,0,c.width,c.height);
 let all=[...candles];if(cur)all.push(cur);
 if(!all.length)return;
 let prices=all.flatMap(x=>[x.h,x.l]);
 let min=Math.min(...prices),max=Math.max(...prices),r=max-min||1;
 let w=c.width/all.length;
 all.forEach((cd,i)=>{
  let x=i*w+w/2;
  let yH=c.height-((cd.h-min)/r)*c.height;
  let yL=c.height-((cd.l-min)/r)*c.height;
  let yO=c.height-((cd.o-min)/r)*c.height;
  let yC=c.height-((cd.c-min)/r)*c.height;
  ctx.strokeStyle=cd.c>=cd.o?"#22c55e":"#ef4444";
  ctx.beginPath();ctx.moveTo(x,yH);ctx.lineTo(x,yL);ctx.stroke();
  ctx.fillStyle=ctx.strokeStyle;
  ctx.fillRect(x-w/4,Math.min(yO,yC),w/2,Math.abs(yO-yC)||2);
 });
}

function loadHistory(){
 onSnapshot(query(collection(db,"trades"),where("uid","==",auth.currentUser.uid),orderBy("time","desc")),s=>{
  tab-history.innerHTML="";
  s.forEach(d=>{
   let t=d.data();
   tab-history.innerHTML+=`<div class="card">${t.type.toUpperCase()} Qty:${t.qty}<br>₹${t.price.toFixed(2)}</div>`;
  });
 });
}

async function loadLeaderboard(){
 let snap=await getDocs(collection(db,"users")),arr=[];
 snap.forEach(d=>{
  let u=d.data(),eq=u.wallet+(u.qty*price);
  arr.push(eq);
 });
 arr.sort((a,b)=>b-a);
 tab-leader.innerHTML=arr.slice(0,10).map((e,i)=>`<div class="card">#${i+1} ₹${e.toFixed(2)}</div>`).join("");
}
</script>
</body>
</html>
