<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAHI Pro | Trading</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0b0e14; --card: #161b22; --primary: #38bdf8; --green: #22c55e; --red: #ef4444; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: white; }
        .container { max-width: 420px; margin: auto; padding: 15px; min-height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        .glass-card { background: linear-gradient(145deg, #1e293b, #0f172a); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 18px; margin-bottom: 15px; }
        .price-big { font-size: 38px; font-weight: 800; margin: 5px 0; }
        .tab-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .tab-btn { background: #1e293b; border: none; color: #94a3b8; padding: 12px; border-radius: 12px; cursor: pointer; }
        .tab-btn.active { background: var(--primary); color: #000; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: auto; }
        .btn { padding: 16px; border: none; border-radius: 15px; font-weight: 800; cursor: pointer; }
        .buy { background: var(--green); color: #000; }
        .sell { background: var(--red); color: #fff; }
        #chart-wrap { height: 200px; width: 100%; margin: 10px 0; }
    </style>
</head>
<body>

<div id="login-page" class="container" style="justify-content:center; text-align:center;">
    <h1 style="letter-spacing:5px;">SAHI</h1>
    <button onclick="login()" style="width:100%; padding:15px; border-radius:15px; font-weight:bold; cursor:pointer;">Continue with Google</button>
</div>

<div id="app-page" class="container hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div style="display:flex; gap:10px; align-items:center;">
            <div id="u-pfp" style="width:35px; height:35px; background:var(--primary); border-radius:50%; display:grid; place-items:center; color:black; font-weight:bold;">U</div>
            <div id="u-name">Trader</div>
        </div>
        <button onclick="logout()" style="background:none; border:none; color:#666; cursor:pointer;">Logout</button>
    </div>

    <div class="glass-card">
        <div style="opacity:0.6; font-size:12px;">Lightspeed / INR</div>
        <div id="price-val" class="price-big">₹0.00</div>
        <div id="price-change" style="font-size:14px;">+0.00%</div>
        <div id="chart-wrap"><canvas id="liveChart"></canvas></div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('market')">Market</button>
        <button class="tab-btn" onclick="switchTab('history')">History</button>
        <button class="tab-btn" onclick="switchTab('wallet')">Wallet</button>
    </div>

    <div id="market-sec">
        <div class="glass-card" style="display:grid; grid-template-columns:1fr 1fr; text-align:center;">
            <div style="border-right:1px solid #333;">Balance<br><b id="ui-bal">₹0.00</b></div>
            <div>Holdings<br><b id="ui-qty">0 LSC</b></div>
        </div>
        <div class="btn-group">
            <button class="btn sell" onclick="trade('sell')">SELL</button>
            <button class="btn buy" onclick="trade('buy')">BUY</button>
        </div>
    </div>

    <div id="history-sec" class="hidden"></div>
    <div id="wallet-sec" class="hidden">
        <div class="glass-card">
            <h3>Add/Withdraw Funds</h3>
            <input type="number" id="w-amt" placeholder="Amount" style="width:100%; padding:12px; border-radius:10px; background:#000; border:1px solid #333; color:white;">
            <div class="btn-group" style="margin-top:15px;">
                <button class="btn buy" onclick="fundReq('Deposit')">Deposit</button>
                <button class="btn sell" onclick="fundReq('Withdraw')">Withdraw</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, where, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { /* PASTE YOUR CONFIG HERE */ };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app), db = getFirestore(app), provider = new GoogleAuthProvider();

    let chart, livePrice = 166.0, userData = {wallet:0, qty:0};
    let cData = [], cLabels = [];

    // --- Tab Switcher ---
    window.switchTab = (t) => {
        ['market', 'history', 'wallet'].forEach(s => document.getElementById(s+'-sec').classList.add('hidden'));
        document.getElementById(t+'-sec').classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    };

    // --- Auth ---
    window.login = () => signInWithPopup(auth, provider);
    window.logout = () => signOut(auth).then(() => location.reload());

    onAuthStateChanged(auth, async (u) => {
        if (u) {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('app-page').classList.remove('hidden');
            document.getElementById('u-name').innerText = u.displayName;
            document.getElementById('u-pfp').innerText = u.displayName[0];

            const uRef = doc(db, "users", u.uid);
            const snap = await getDoc(uRef);
            if(!snap.exists()) await setDoc(uRef, {wallet:10000, qty:0, name: u.displayName});
            onSnapshot(uRef, d => { 
                userData = d.data(); 
                document.getElementById('ui-bal').innerText = "₹"+userData.wallet.toFixed(2);
                document.getElementById('ui-qty').innerText = userData.qty + " LSC";
            });

            initChart();
            startSmartMarket();
            loadHistory(u.uid);
        }
    });

    // --- Market Engine ---
    async function startSmartMarket() {
        const historyRef = collection(db, "market_history");
        const configRef = doc(db, "settings", "market_config");

        // Load History
        const qH = query(historyRef, orderBy("time", "desc"), limit(25));
        const hSnap = await getDocs(qH);
        hSnap.forEach(d => { cData.unshift(d.data().price); cLabels.unshift(""); });
        chart.update();

        onSnapshot(configRef, (s) => {
            const conf = s.data() || {minPrice:160, maxPrice:175, targetPrice:170};
            setInterval(async () => {
                let drift = (Math.random() - 0.5) * 0.4;
                if(livePrice >= conf.maxPrice) livePrice -= 0.5;
                else if(livePrice <= conf.minPrice) livePrice += 0.5;
                else livePrice += drift;

                if(livePrice < conf.targetPrice) livePrice += 0.03; else livePrice -= 0.03;

                document.getElementById('price-val').innerText = "₹"+livePrice.toFixed(2);
                cData.push(livePrice); cLabels.push("");
                if(cData.length > 25) { cData.shift(); cLabels.shift(); }
                chart.update();

                if(new Date().getSeconds() % 30 === 0) {
                    await addDoc(historyRef, {price: livePrice, time: serverTimestamp()});
                }
            }, 3000);
        });
    }

    function initChart() {
        chart = new Chart(document.getElementById('liveChart'), {
            type: 'line',
            data: { labels: cLabels, datasets: [{ data: cData, borderColor: '#38bdf8', borderWidth: 3, tension: 0.4, pointRadius: 0, fill: true, backgroundColor: 'rgba(56,189,248,0.1)' }] },
            options: { responsive:true, maintainAspectRatio:false, plugins:{legend:false}, scales:{x:{display:false}, y:{grid:{color:'#222'}}} }
        });
    }

    window.trade = async (mode) => {
        const qty = parseInt(prompt("Qty:")); if(!qty) return;
        const total = qty * livePrice;
        const ref = doc(db, "users", auth.currentUser.uid);
        if(mode === 'buy' && userData.wallet >= total) {
            await updateDoc(ref, {wallet: userData.wallet - total, qty: userData.qty + qty});
        } else if(mode === 'sell' && userData.qty >= qty) {
            await updateDoc(ref, {wallet: userData.wallet + total, qty: userData.qty - qty});
        } else { return alert("Invalid Transaction"); }
        await addDoc(collection(db, "trades"), {uid: auth.currentUser.uid, type: mode, qty, price: livePrice, time: serverTimestamp()});
    };
</script>
</body>
</html>
