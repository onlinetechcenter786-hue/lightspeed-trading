<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAHI | Lightspeed Trading</title>
    <style>
        :root { --primary: #6366f1; --bg: #0b0e14; --card: #161b22; --accent: #38bdf8; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; overflow-x: hidden; }
        .container { max-width: 420px; margin: auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        
        /* Login UI */
        .brand { text-align: center; margin: 40px 0; }
        .brand h1 { font-size: 36px; letter-spacing: 4px; margin: 0; font-weight: 900; }
        .hero-text { text-align: center; font-size: 28px; font-weight: bold; margin-bottom: 40px; }
        .google-btn { 
            background: #fff; color: #000; width: 100%; padding: 15px; border: none; border-radius: 12px; 
            font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        /* Trading Dashboard */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .wallet-card { background: var(--card); padding: 15px; border-radius: 15px; border: 1px solid #30363d; margin-bottom: 20px; }
        .price-section { text-align: center; margin: 20px 0; }
        .price { font-size: 42px; font-weight: 800; transition: 0.3s; }
        .up { color: #22c55e; } .down { color: #ef4444; }
        
        canvas { width: 100%; height: 180px; background: rgba(0,0,0,0.2); border-radius: 10px; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .stat-box { background: var(--card); padding: 12px; border-radius: 10px; text-align: center; border: 1px solid #30363d; }
        
        .trade-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        button.buy { background: #22c55e; color: #000; padding: 16px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; }
        button.sell { background: #ef4444; color: #fff; padding: 16px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; }
        .deposit-btn { background: #30363d; color: #fff; width: 100%; padding: 12px; border: none; border-radius: 10px; margin-top: 15px; cursor: pointer; font-size: 12px; }

        .footer-text { font-size: 10px; opacity: 0.4; text-align: center; margin-top: auto; padding: 20px 0; }
    </style>
</head>
<body>

<div id="auth-screen" class="container">
    <div class="brand"><h1>SAHI</h1></div>
    <div class="hero-text">High Performance<br>Trading</div>
    <div style="background: rgba(255,255,255,0.03); padding: 30px; border-radius: 20px; border: 1px solid #30363d;">
        <button class="google-btn" onclick="login()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18">
            Continue with Google
        </button>
    </div>
    <div class="footer-text">SEBI Registered Broker • IFTA Startup of the Year 2025</div>
</div>

<div id="app-screen" class="container hidden">
    <div class="header">
        <span style="font-weight: bold; color: var(--accent);">Lightspeed (LSC)</span>
        <button onclick="logout()" style="background:none; border:none; color:#ef4444; cursor:pointer;">Logout</button>
    </div>

    <div class="wallet-card">
        <div style="font-size: 12px; opacity: 0.6;">Available Margin</div>
        <div style="font-size: 24px; font-weight: bold;">₹<span id="bal-val">0.00</span></div>
    </div>

    <div class="price-section">
        <div class="price" id="price-val">₹166.65</div>
        <div id="pl-val" style="font-size: 14px; margin-top: 5px;">P/L: ₹0.00</div>
    </div>

    <canvas id="liveChart"></canvas>

    <div class="stats-grid">
        <div class="stat-box">
            <div style="font-size:10px; opacity:0.6;">HOLDINGS</div>
            <div id="hold-val" style="font-weight:bold;">0</div>
        </div>
        <div class="stat-box">
            <div style="font-size:10px; opacity:0.6;">AVG PRICE</div>
            <div id="avg-val" style="font-weight:bold;">₹0</div>
        </div>
    </div>

    <div class="trade-btns">
        <button class="buy" onclick="handleTrade('buy')">BUY</button>
        <button class="sell" onclick="handleTrade('sell')">SELL</button>
    </div>

    <button class="deposit-btn" onclick="addMoney()">ADD MONEY (Deposit Request)</button>
    
    <div class="footer-text">Real-time market simulation • No real money involved</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCuCNl6FOWldVkjGAlqU1eTxPPOWn_pKtY",
        authDomain: "lightspeed-trading-1dec9.firebaseapp.com",
        projectId: "lightspeed-trading-1dec9",
        storageBucket: "lightspeed-trading-1dec9.firebasestorage.app",
        messagingSenderId: "787355268629",
        appId: "1:787355268629:web:c5c39b7706c6a3548e001c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentPrice = 166.65;
    let userDbData = {};
    let priceHistory = [166.65, 166.80, 166.50];

    // Auth Functions
    window.login = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userRef = doc(db, "users", user.uid);
            const snap = await getDoc(userRef);
            if (!snap.exists()) {
                await setDoc(userRef, { wallet: 10000, holdings: 0, avgPrice: 0, name: user.displayName });
            }
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            
            onSnapshot(userRef, (d) => {
                userDbData = d.data();
                updateUI();
            });
            startMarket();
        } else {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }
    });

    // Market Logic
    function startMarket() {
        setInterval(() => {
            let change = (Math.random() - 0.5) * 2;
            currentPrice += change;
            priceHistory.push(currentPrice);
            if(priceHistory.length > 40) priceHistory.shift();
            
            const pEl = document.getElementById('price-val');
            pEl.innerText = "₹" + currentPrice.toFixed(2);
            pEl.className = "price " + (change >= 0 ? "up" : "down");
            
            updatePL();
            drawChart();
        }, 2000);
    }

    // Trade Logic
    window.handleTrade = async (type) => {
        const userRef = doc(db, "users", auth.currentUser.uid);
        if (type === 'buy' && userDbData.wallet >= currentPrice) {
            let newHoldings = userDbData.holdings + 1;
            let newAvg = ((userDbData.holdings * userDbData.avgPrice) + currentPrice) / newHoldings;
            await updateDoc(userRef, { wallet: userDbData.wallet - currentPrice, holdings: newHoldings, avgPrice: newAvg });
        } else if (type === 'sell' && userDbData.holdings > 0) {
            let newHoldings = userDbData.holdings - 1;
            await updateDoc(userRef, { wallet: userDbData.wallet + currentPrice, holdings: newHoldings, avgPrice: newHoldings === 0 ? 0 : userDbData.avgPrice });
        }
    };

    window.addMoney = async () => {
        const amt = prompt("Enter amount to deposit (₹):");
        if(amt && !isNaN(amt)) {
            await addDoc(collection(db, "requests"), {
                uid: auth.currentUser.uid,
                phone: auth.currentUser.email, // using email as identifier
                amount: parseFloat(amt),
                status: "pending",
                time: serverTimestamp()
            });
            alert("Deposit request submitted to Admin!");
        }
    }

    function updateUI() {
        document.getElementById('bal-val').innerText = userDbData.wallet.toFixed(2);
        document.getElementById('hold-val').innerText = userDbData.holdings;
        document.getElementById('avg-val').innerText = "₹" + userDbData.avgPrice.toFixed(2);
    }

    function updatePL() {
        if(userDbData.holdings > 0) {
            let pl = (currentPrice - userDbData.avgPrice) * userDbData.holdings;
            const el = document.getElementById('pl-val');
            el.innerText = "P/L: ₹" + pl.toFixed(2);
            el.style.color = pl >= 0 ? "#22c55e" : "#ef4444";
        }
    }

    function drawChart() {
        const canvas = document.getElementById('liveChart');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        ctx.strokeStyle = "#38bdf8";
        ctx.lineWidth = 3;
        let min = Math.min(...priceHistory), max = Math.max(...priceHistory), range = max - min + 1;
        priceHistory.forEach((p, i) => {
            let x = (i / (priceHistory.length - 1)) * canvas.width;
            let y = canvas.height - ((p - min) / range) * canvas.height;
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.stroke();
    }
</script>
</body>
</html>
