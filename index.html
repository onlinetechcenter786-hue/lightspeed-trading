<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAHI Pro | Trading</title>
    <style>
        :root { --bg: #0b0e14; --card: #161b22; --primary: #38bdf8; --green: #22c55e; --red: #ef4444; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: white; }
        .container { max-width: 420px; margin: auto; padding: 20px; }
        .hidden { display: none !important; }
        
        /* Glassmorphism Card Style */
        .glass-card { 
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Header & Profile */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 35px; height: 35px; background: var(--primary); border-radius: 50%; display: grid; place-items: center; font-weight: bold; }
        .logout-btn { background: none; border: 1px solid #333; color: #666; padding: 5px 12px; border-radius: 8px; cursor: pointer; }

        /* Price & Chart */
        .symbol { font-size: 18px; opacity: 0.7; }
        .price-main { font-size: 38px; font-weight: 800; margin: 5px 0; }
        .change { font-size: 16px; font-weight: 600; }
        canvas { width: 100%; height: 160px; margin: 20px 0; }

        /* Tabs */
        .tabs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .tab-btn { background: #1e293b; border: none; color: #94a3b8; padding: 10px; border-radius: 12px; font-weight: 600; cursor: pointer; }
        .tab-btn.active { background: var(--primary); color: #000; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px; }
        .stat-item { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 15px; }
        .stat-val { display: block; font-size: 18px; font-weight: bold; margin-top: 5px; }

        /* Action Buttons */
        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }
        .btn { padding: 16px; border: none; border-radius: 18px; font-weight: 800; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .btn-buy { background: var(--green); color: #000; }
        .btn-sell { background: var(--red); color: #fff; }
        .btn:active { transform: scale(0.95); }

        /* Login Screen */
        .login-screen { text-align: center; padding-top: 100px; }
        .google-login { background: white; color: black; width: 100%; padding: 15px; border-radius: 15px; font-weight: bold; border: none; margin-top: 40px; }
    </style>
</head>
<body>

<div id="auth-page" class="container login-screen">
    <h1 style="letter-spacing: 4px;">SAHI</h1>
    <p style="opacity: 0.6;">High Performance Trading</p>
    <button class="google-login" onclick="login()">Continue with Google</button>
</div>

<div id="app-page" class="container hidden">
    <div class="header">
        <div class="user-info">
            <div class="avatar" id="user-initial">U</div>
            <div style="font-size: 14px;">Hi, <b id="user-name">Trader</b></div>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div class="glass-card">
        <div class="symbol">Lightspeed / INR <span style="background:orange; color:black; font-size:10px; padding:2px 6px; border-radius:4px; margin-left:10px;">LSC</span></div>
        <div class="price-main" id="price-val">₹0.00</div>
        <div class="change" id="price-change">+₹0.00 (0.00%)</div>
        <canvas id="proChart"></canvas>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('market')">Market</button>
        <button class="tab-btn" onclick="showTab('history')">History</button>
        <button class="tab-btn" onclick="showTab('leader')">Rank</button>
    </div>

    <div id="market-sec">
        <div class="glass-card stats-grid">
            <div class="stat-item">
                <span style="opacity:0.6;">Wallet Balance</span>
                <span class="stat-val">₹<span id="stat-bal">0.00</span></span>
            </div>
            <div class="stat-item">
                <span style="opacity:0.6;">Holdings</span>
                <span class="stat-val"><span id="stat-qty">0</span> LSC</span>
            </div>
            <div class="stat-item">
                <span style="opacity:0.6;">Avg Price</span>
                <span class="stat-val">₹<span id="stat-avg">0.00</span></span>
            </div>
            <div class="stat-item">
                <span style="opacity:0.6;">Unrealized P/L</span>
                <span class="stat-val" id="stat-pl">₹0.00</span>
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-sell" onclick="openTrade('sell')">Sell · Short</button>
            <button class="btn btn-buy" onclick="openTrade('buy')">Buy · Long</button>
        </div>
    </div>

    <div id="history-sec" class="hidden"></div>
    <div id="leader-sec" class="hidden"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCuCNl6FOWldVkjGAlqU1eTxPPOWn_pKtY",
        authDomain: "lightspeed-trading-1dec9.firebaseapp.com",
        projectId: "lightspeed-trading-1dec9",
        storageBucket: "lightspeed-trading-1dec9.firebasestorage.app",
        messagingSenderId: "787355268629",
        appId: "1:787355268629:web:c5c39b7706c6a3548e001c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app), db = getFirestore(app), provider = new GoogleAuthProvider();

    let price = 163.10, lastPrice = 160.00;
    let userData = { wallet: 0, qty: 0, avg: 0 };
    let chartData = [];

    // --- AUTH LOGIC ---
    window.login = () => signInWithPopup(auth, provider).catch(e => alert("Error: Use Google Login Only"));
    window.logout = () => signOut(auth).then(() => location.reload());

    onAuthStateChanged(auth, async (u) => {
        if (u) {
            document.getElementById('auth-page').classList.add('hidden');
            document.getElementById('app-page').classList.remove('hidden');
            
            // Set User Identity
            document.getElementById('user-name').innerText = u.displayName || "Trader";
            document.getElementById('user-initial').innerText = (u.displayName || "U").charAt(0);

            const uRef = doc(db, "users", u.uid);
            const snap = await getDoc(uRef);
            if (!snap.exists()) await setDoc(uRef, { wallet: 10000, qty: 0, avg: 0, name: u.displayName });

            onSnapshot(uRef, (d) => {
                userData = d.data();
                // Fix NaN issues with default values
                document.getElementById('stat-bal').innerText = (userData.wallet || 0).toFixed(2);
                document.getElementById('stat-qty').innerText = userData.qty || 0;
                document.getElementById('stat-avg').innerText = (userData.avg || 0).toFixed(2);
                updatePL();
            });
            startMarket();
            loadHistory();
        }
    });

    // --- MARKET LOGIC ---
    function startMarket() {
        setInterval(() => {
            lastPrice = price;
            price += (Math.random() - 0.5) * 2;
            renderMarket();
        }, 3000);
    }

    function renderMarket() {
        const pVal = document.getElementById('price-val');
        pVal.innerText = "₹" + price.toFixed(2);
        pVal.className = "price-main " + (price >= lastPrice ? "up" : "down");
        
        const diff = price - 160.00; // Starting base price for change calculation
        const perc = (diff / 160) * 100;
        document.getElementById('price-change').innerText = `${diff >= 0 ? '+' : ''}₹${diff.toFixed(2)} (${perc.toFixed(2)}%)`;
        document.getElementById('price-change').style.color = diff >= 0 ? "var(--green)" : "var(--red)";

        chartData.push(price);
        if (chartData.length > 30) chartData.shift();
        drawChart();
        updatePL();
    }

    function updatePL() {
        const pl = (price - (userData.avg || 0)) * (userData.qty || 0);
        const el = document.getElementById('stat-pl');
        el.innerText = (pl >= 0 ? "+" : "") + "₹" + pl.toFixed(2);
        el.style.color = pl >= 0 ? "var(--green)" : "var(--red)";
    }

    // --- CHART ---
    function drawChart() {
        const c = document.getElementById('proChart');
        const ctx = c.getContext('2d');
        ctx.clearRect(0,0,c.width,c.height);
        
        const min = Math.min(...chartData), max = Math.max(...chartData), range = max - min || 1;
        ctx.beginPath();
        ctx.strokeStyle = "#38bdf8"; ctx.lineWidth = 3;
        ctx.shadowBlur = 10; ctx.shadowColor = "#38bdf8";

        chartData.forEach((p, i) => {
            const x = (i / (chartData.length - 1)) * c.width;
            const y = c.height - ((p - min) / range) * c.height;
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.stroke();
    }

    // --- TABS ---
    window.showTab = (tab) => {
        ['market', 'history', 'leader'].forEach(t => {
            document.getElementById(t + '-sec').classList.add('hidden');
        });
        document.getElementById(tab + '-sec').classList.remove('hidden');
    }

    // --- TRADING ---
    window.openTrade = async (mode) => {
        const qty = prompt(`Enter quantity to ${mode}:`, "1");
        if (!qty || isNaN(qty)) return;
        const q = parseInt(qty);
        const total = q * price;
        const uRef = doc(db, "users", auth.currentUser.uid);

        if (mode === 'buy' && userData.wallet >= total) {
            const newQty = (userData.qty || 0) + q;
            const newAvg = (((userData.avg || 0) * (userData.qty || 0)) + (price * q)) / newQty;
            await updateDoc(uRef, { wallet: userData.wallet - total, qty: newQty, avg: newAvg });
        } else if (mode === 'sell' && userData.qty >= q) {
            await updateDoc(uRef, { wallet: userData.wallet + total, qty: userData.qty - q });
        } else {
            alert("Transaction Failed: Check balance/holdings");
        }
        
        await addDoc(collection(db, "trades"), {
            uid: auth.currentUser.uid,
            type: mode, qty: q, price: price, time: serverTimestamp()
        });
    }

    function loadHistory() {
        const q = query(collection(db, "trades"), where("uid", "==", auth.currentUser.uid), orderBy("time", "desc"));
        onSnapshot(q, (s) => {
            const hSec = document.getElementById('history-sec');
            hSec.innerHTML = "<h3 style='margin:10px 0'>Trade History</h3>";
            s.forEach(d => {
                const t = d.data();
                hSec.innerHTML += `<div class="glass-card" style="padding:12px; margin-bottom:10px; border-left:4px solid ${t.type == 'buy' ? 'var(--green)' : 'var(--red)'}">
                    <b>${t.type.toUpperCase()} ${t.qty} LSC</b> <span style="float:right; opacity:0.5;">₹${t.price.toFixed(2)}</span>
                </div>`;
            });
        });
    }
</script>
</body>
</html>
