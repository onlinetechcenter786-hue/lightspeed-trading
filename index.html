<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightspeed Trading</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0b0e14; --card: #161b22; --primary: #38bdf8; --green: #22c55e; --red: #ef4444; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: white; }
        .container { max-width: 420px; margin: auto; padding: 15px; min-height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        .u-avatar { width: 45px; height: 45px; background: var(--primary); border-radius: 50%; display: grid; place-items: center; font-weight: bold; color: #000; font-size: 20px;}
        
        .glass-card { background: var(--card); border-radius: 24px; padding: 20px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); position: relative; overflow: hidden; }
        .price-text { font-size: 48px; font-weight: 800; margin: 10px 0; }
        .chart-box { height: 200px; width: 100%; margin: 10px 0; }

        .tab-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .tab-btn { background: #1e293b; border: none; color: #94a3b8; padding: 12px; border-radius: 15px; font-weight: 600; cursor: pointer; }
        .tab-btn.active { background: var(--primary); color: #000; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat-item { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.05); }
        .stat-label { font-size: 13px; opacity: 0.6; margin-bottom: 5px; }
        .stat-value { font-size: 18px; font-weight: bold; display: block; }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: auto; padding-bottom: 20px; }
        .btn { padding: 20px; border: none; border-radius: 20px; font-weight: 800; font-size: 16px; cursor: pointer; }
        .buy { background: var(--green); color: #000; }
        .sell { background: var(--red); color: #fff; }
    </style>
</head>
<body>

<div id="login-page" class="container" style="justify-content: center; text-align: center;">
    <h1 style="font-size: 60px; letter-spacing: 5px; margin-bottom: 0;">SAHI</h1>
    <p style="opacity: 0.5; margin-bottom: 40px;">LIGHTSPEED PRO TERMINAL</p>
    <button onclick="login()" style="width: 100%; padding: 20px; border-radius: 20px; font-weight: bold; cursor: pointer; background: white; border: none; font-size: 16px;">Login with Google</button>
</div>

<div id="app-page" class="container hidden">
    <div class="header">
        <div style="display:flex; align-items:center; gap:12px;">
            <div id="u-initial" class="u-avatar">?</div>
            <div>Hi, <b id="u-display-name">Trader</b></div>
        </div>
        <button onclick="logout()" style="background:#1e293b; color:#ccc; border:none; padding:8px 15px; border-radius:10px; cursor:pointer;">Logout</button>
    </div>

    <div id="market-section">
        <div class="glass-card">
            <div style="font-size:14px; opacity:0.6;">Lightspeed / INR <span style="background:orange; color:black; font-size:10px; padding:2px 4px; border-radius:4px; font-weight:bold; vertical-align:middle;">LSC</span></div>
            <div id="price-val" class="price-text">₹0.00</div>
            <div id="price-change" style="font-weight:bold; font-size:18px;">+0.00%</div>
            <div class="chart-box"><canvas id="mainChart"></canvas></div>
        </div>

        <div class="tab-bar">
            <button id="btn-market" class="tab-btn active" onclick="showTab('market')">Market</button>
            <button id="btn-history" class="tab-btn" onclick="showTab('history')">History</button>
            <button id="btn-wallet" class="tab-btn" onclick="showTab('wallet')">Wallet</button>
        </div>

        <div class="stats-grid">
            <div class="stat-item"><div class="stat-label">Wallet Balance</div><span class="stat-value" id="ui-wallet">₹0.00</span></div>
            <div class="stat-item"><div class="stat-label">Holdings</div><span class="stat-value" id="ui-holdings">0 LSC</span></div>
            <div class="stat-item"><div class="stat-label">Avg Price</div><span class="stat-value" id="ui-avg">₹0.00</span></div>
            <div class="stat-item"><div class="stat-label">Unrealized P/L</div><span class="stat-value" id="ui-pl">₹0.00</span></div>
        </div>

        <div class="btn-group">
            <button class="btn sell" onclick="doTrade('sell')">Sell • Short</button>
            <button class="btn buy" onclick="doTrade('buy')">Buy • Long</button>
        </div>
    </div>

    <div id="history-section" class="hidden"><h3>Trade History</h3><div id="history-list"></div></div>
    <div id="wallet-section" class="hidden">
        <h3>Wallet</h3>
        <div class="glass-card">
            <input type="number" id="w-amount" placeholder="Amount" style="width:100%; padding:15px; background:#000; border:1px solid #333; color:white; border-radius:15px; box-sizing:border-box;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
                <button onclick="fundRequest('Deposit')" class="btn buy" style="padding:15px">Deposit</button>
                <button onclick="fundRequest('Withdraw')" class="btn sell" style="padding:15px">Withdraw</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, where, orderBy, limit, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCuCNl6FOWldVkjGAlqU1eTxPPOWn_pKtY",
        authDomain: "lightspeed-trading-1dec9.firebaseapp.com",
        projectId: "lightspeed-trading-1dec9",
        storageBucket: "lightspeed-trading-1dec9.firebasestorage.app",
        messagingSenderId: "787355268629",
        appId: "1:787355268629:web:c5c39b7706c6a3548e001c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app), db = getFirestore(app), provider = new GoogleAuthProvider();
    let chart, livePrice = 165.00, user = { wallet: 0, qty: 0, avg: 0 };

    window.login = () => signInWithPopup(auth, provider);
    window.logout = () => signOut(auth).then(() => location.reload());

    window.showTab = (tab) => {
        ['market', 'history', 'wallet'].forEach(t => {
            document.getElementById(t+'-section').classList.add('hidden');
            document.getElementById('btn-'+t).classList.remove('active');
        });
        document.getElementById(tab+'-section').classList.remove('hidden');
        document.getElementById('btn-'+tab).classList.add('active');
    };

    onAuthStateChanged(auth, async (u) => {
        if (u) {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('app-page').classList.remove('hidden');
            document.getElementById('u-display-name').innerText = u.displayName;
            document.getElementById('u-initial').innerText = u.displayName[0];

            const uRef = doc(db, "users", u.uid);
            onSnapshot(uRef, d => {
                if(d.exists()) {
                    user = d.data();
                    document.getElementById('ui-wallet').innerText = "₹" + (user.wallet || 0).toFixed(2);
                    document.getElementById('ui-holdings').innerText = (user.qty || 0) + " LSC";
                    document.getElementById('ui-avg').innerText = "₹" + (user.avg || 0).toFixed(2);
                    let pl = (livePrice - (user.avg || 0)) * user.qty;
                    document.getElementById('ui-pl').innerText = (pl >= 0 ? "+" : "") + "₹" + pl.toFixed(2);
                    document.getElementById('ui-pl').style.color = pl >= 0 ? "var(--green)" : "var(--red)";
                } else {
                    setDoc(uRef, { wallet: 5000, qty: 0, avg: 0, name: u.displayName });
                }
            });

            initChart();
            startMarketSync();
            loadHistory(u.uid);
        }
    });

    function initChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ data: [], borderColor: '#38bdf8', borderWidth: 3, tension: 0.4, fill: true, backgroundColor: 'rgba(56,189,248,0.1)', pointRadius: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false }, scales: { x: { display: false }, y: { display: false } } }
        });
    }

    async function startMarketSync() {
        // Load initial history
        const hQuery = query(collection(db, "market_history"), orderBy("time", "desc"), limit(25));
        onSnapshot(hQuery, s => {
            const history = s.docs.map(d => d.data().price).reverse();
            if(history.length > 0) {
                livePrice = history[history.length-1];
                document.getElementById('price-val').innerText = "₹" + livePrice.toFixed(2);
                
                chart.data.labels = history.map(() => "");
                chart.data.datasets[0].data = history;
                chart.update();

                let diff = livePrice - 165;
                let perc = (diff / 165) * 100;
                document.getElementById('price-change').innerText = (diff >= 0 ? "+" : "") + "₹" + diff.toFixed(2) + " (" + perc.toFixed(2) + "%)";
                document.getElementById('price-change').style.color = diff >= 0 ? "var(--green)" : "var(--red)";
            }
        });
    }

    window.doTrade = async (mode) => {
        const qty = parseInt(prompt(`LSC to ${mode.toUpperCase()}?`));
        if(!qty || qty <= 0) return;
        const total = qty * livePrice;
        const uRef = doc(db, "users", auth.currentUser.uid);

        if(mode === 'buy') {
            if(user.wallet < total) return alert("Low Balance");
            let newAvg = ((user.avg * user.qty) + total) / (user.qty + qty);
            await updateDoc(uRef, { wallet: user.wallet - total, qty: user.qty + qty, avg: newAvg });
        } else {
            if(user.qty < qty) return alert("Not enough LSC");
            await updateDoc(uRef, { wallet: user.wallet + total, qty: user.qty - qty });
        }
        await addDoc(collection(db, "trades"), { uid: auth.currentUser.uid, type: mode, qty, price: livePrice, time: serverTimestamp() });
    };

    function loadHistory(uid) {
        onSnapshot(query(collection(db, "trades"), where("uid", "==", uid), orderBy("time", "desc")), s => {
            const list = document.getElementById('history-list');
            list.innerHTML = "";
            s.forEach(d => {
                const t = d.data();
                list.innerHTML += `<div class="glass-card" style="padding:15px; margin-bottom:10px; border-left:5px solid ${t.type=='buy'?'var(--green)':'var(--red)'}">
                    <div style="display:flex; justify-content:space-between;"><b>${t.type.toUpperCase()} ${t.qty} LSC</b><span>₹${(t.qty*t.price).toFixed(2)}</span></div>
                </div>`;
            });
        });
    }

    window.fundRequest = async (type) => {
        const amt = parseFloat(document.getElementById('w-amount').value);
        if(!amt || amt < 100) return alert("Min ₹100");
        await addDoc(collection(db, "requests"), { uid: auth.currentUser.uid, email: auth.currentUser.email, amount: amt, type, status: "pending", time: serverTimestamp() });
        alert("Request Sent!");
    };
</script>
</body>
</html>
